# Helidon Maven Plugin

This plugin provides Maven goals specific to Helidon applications as well as goals for general usage.

#### Goals for Helidon Applications

* [native-image](#goal-native-image)
* [jlink-image](#goal-jlink-image)

#### Goals for All Applications

* [root-dir](#goal-root-dir)
* [echo](#goal-echo)

## Goal: `native-image`

Maven goal to invoke GraalVM `native-image` command.

This plugin binds to the `package` phase by default.

### Optional Parameters

| Property | Type | Default<br/>Value | Description |
| --- | --- | --- | --- |
| graalVMHome | File | `${env.GRAALVM_HOME}` | GraalVM home |
| reportExceptionStackTraces | Boolean | `true` | Show exception stack traces for exceptions during image building |
| buildShared | Boolean | `false` | Build shared library |
| buildStatic | Boolean | `false` | Build statically linked executable (requires static `libc` and `zlib` |
| noServer | Boolean | `true` | Do not use image-build server |
| addProjectResources | Boolean | `true` | Indicates if project build resources should be added to the image |
| includeResources | List | [] | List of regexp matching names of resources to be included in the image |
| additionalArgs | List | [] | Additional command line arguments |
| skipNativeImage | Boolean | `false` | Skip this goal execution |
| execMode | enum | `jar` | Execution mode - `jar`, `jar-cp`, or `main` |
| mainClass | String | `${mainClass}` | Main class to use when execMode is set to `main` | 

The parameters `reportExceptionStackTraces`, `noServer`, `buildShared`,
 `buildStatic` and `skipNativeImage` are mapped to user properties of the form:
 `native.image.PROPERTY`. The parameter `siteArchiveSkip` is mapped to:
 `native.image.skip`. 
The parameter `execMode` is maped to property `native.image.execMode`.
The parameter `mainClass` is mapped to property `native.image.mainClass`.

### Specifying the path to `native-image`

There are 3 ways to specify the path to the `native-image` command:
* export `GRAALVM_HOME` in your environment
* set the `graalVMHome` Maven property (either in the pom or with -D on the
 command line)
* add the GraalVM `bin` folder to your PATH environment variable

If the plugin fails to determine the path to `native-image`, the build will
 fail with an error.

### Adding build resources

When `addProjectResources` is `true` (the default), the plugin will automatically
 add the processed project resources to the image. I.e the files from
 `src/main/resources` processed under the `target/classes` directory.

You can manually include additional files with the `includeResources` parameter.

### General usage

 A good practice would be to define an execution for this goal under a profile
 named `native-image`.

```xml
    <profiles>
        <profile>
            <id>native-image</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.helidon.build-tools</groupId>
                        <artifactId>helidon-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <goals>
                                    <goal>native-image</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>
```

You then build your native image with the following command:

```bash
mvn package -Pnative-image
```

You can also execute this plugin outside of a configured life-cycle, however
 it requires the project jar to be present:

```bash
mvn package
mvn helidon:native-image
```

### Execution modes
#### jar
Jar execution mode uses the jar generated by this build as the target for
native-image build, and expects the jar file manifest to contain the
 `Main-Class` with the entry point, and `Class-Path` with location of all required libraries.
 
This is the default execution mode and will work with Helidon quickstart projects.

#### jar-cp
Same as `jar` mode, does not expect `Class-Path` in manifest at all.
Adds the runtime classpath to native-image build except for the `target/classes` directory,
as that is included in the built jar.

#### main
Main class execution mode uses the project classpath and a main class as an
entry point for native-image build.

## Goal: `jlink-image`

Maven goal to create a custom Java Runtime Image containing the application jars and the JDK modules 
on which they depend. In addition, it:

* Enables Class Data Sharing by default to reduce startup time. 
* Adds any missing `Jandex` indices for MP applications.
* Generates a custom `start` script to simplify CDS usage and support debug and test modes. 


This plugin binds to the `package` phase by default.

### Optional Parameters

| Property | Type | Default<br/>Value | Description |
| --- | --- | --- | --- |
| defaultJvmOptions | List | [] | JVM options to use if none are passed to the `start` script |
| defaultArgs | List | [] | Application arguments to use if none are passed to the `start` script |
| defaultDebugOptions | List | [] | JVM debug options to use if the `--debug` flag is passed to the `start` script |
| addClassDataSharingArchive | Boolean | `true` | Add a Class Data Sharing archive to reduce startup time |
| testImage | Boolean | `true` | Start the application after the image is built |
| stripDebug | Boolean | `false` | Remove all debug support from the image, including within `.class` files |
| skipJavaImage | Boolean | `false` | Skip this goal execution |

The above parameters are mapped to user properties of the form: `jlink.image.PROPERTY`.
For example `-Djlink.image.addClassDataSharingArchive=false`.

### General usage

A good practice would be to define an execution for this goal under a profile named `jlink-image`.

```xml
    <profiles>
        <profile>
            <id>jlink-image</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>io.helidon.build-tools</groupId>
                        <artifactId>helidon-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <goals>
                                    <goal>jlink-image</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>
```

You then build your image with the following command:

```bash
mvn package -Pjlink-image
```

You can also execute this plugin outside of a configured life-cycle, however
 it requires the project jar to be present and will use only _default_ configuration:

```bash
mvn package
mvn helidon:jlink-image
```

## Goal: `root-dir`

Maven goal to find the top level root directory of the project and store it in a property.

This plugin binds to the `validate` phase by default.

The root directory is stored in a property `top.parent.basedir`.

### General usage

Execution of this plugin can be defined in a build of the parent project, if required
 by every module.

```xml
 <build>
    <plugins>
        <plugin>
            <groupId>io.helidon.build-tools</groupId>
            <artifactId>helidon-maven-plugin</artifactId>
            <executions>
                <execution>
                    <goals>
                        <goal>root-dir</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

## Goal: `echo`

Maven goal to echo messages during a build. Supports 
[rich text](https://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html) via a simple DSL.

### General usage

Execution of this plugin must be explicitly bound to the desired phase, there is no default. The following example
uses the `validate` phase to emit a message as early as possible:  

```xml
 <build>
    <plugins>
        <plugin>
            <groupId>io.helidon.build-tools</groupId>
            <artifactId>helidon-maven-plugin</artifactId>
            <executions>
                <execution>
                    <phase>validate</phase>
                    <goals>
                        <goal>echo</goal>
                    </goals>
                </execution>
            </executions>
            <configuration>
                <messages>
                    <message></message>  
                    <message>Starting ${project.version} build</message>
                    <message></message>  
                </messages>
            </configuration>
        </plugin>
    </plugins>
</build>
```                 
Leading whitespace in messages is removed by default; to preserve it, add the `xml:space="preserve"` attribute:
```
    <message xml:space="preserve">    this is indented</message>
```
This attribute is especially helpful with a multi-line message to preserve indentation.

### Rich text 

Rich text is enabled when the Maven command is executed in a terminal that supports it and output is not redirected.
If the Maven output is in color, your messages can be as well: the same [Jansi](https://github.com/fusesource/jansi) library 
is used for both.

> **_NOTE:_**  Terminals often provide mappings between the standard color names used here and what they actually render. So, for
example, you may declare `red` but a terminal could be configured to render it as an entirely different color. Further, not 
all styles are supported or enabled in every terminal so e.g. the (really annoying) styles like `blinking` may do nothing.

Basic colors and styles are applied to text enclosed by `$(` and `)`, e.g.:
```
   <message>Here is $(red styled) text</message>
```                                              
In this example, the word `styled` will (normally) appear in red. If the styled text itself contains parentheses, the closing paren should be escaped with a backslash:
```
   <message>Here is $(red (and example of\) styled) text</message>
```                                              
The DSL syntax is:
```
   $(code[,code] text)
```
where `code` is a color or other style. The eight standard color names are supported in a few different 
(case-sensitive) variations:

| Color | Plain | Bold | Bright | Bright Bold |
| --- | --- | --- | --- | --- |
| black | `black` | `BLACK` | `black!` | `BLACK!` |
| red | `red` | `RED` | `red!` | `RED!` |
| green | `green` | `GREEN` | `green!` | `GREEN!` |
| yellow | `yellow` | `YELLOW` | `yellow!` | `YELLOW!` |
| blue | `blue` | `BLUE` | `blue!` | `BLUE!` |
| magenta | `magenta` | `MAGENTA` | `magenta!` | `MAGENTA!` |
| cyan | `cyan` | `CYAN` | `cyan!` | `CYAN!` |
| white | `white` | `WHITE` | `white!` | `WHITE!` |

To use any of these as the _background_ instead of the text color, prepend `bg_` or `BG_` if bold, e.g. `bg_blue` or `BG_YELLOW!`.

The following styles can also be used:

 * `bold`
 * `negative`
 * `italic`
 * `underline`
 * `faint`
 * `conceal`
 * `blinking`
 * `blink_fast`  

Note that `bold` is preferable to `WHITE` or `BLACK` as it is independent of the background color. Similarly,
`negative` is preferable to `bg_white` or `bg_black`.
 
Examples:

```
    <message>$(RED!,italic This is a test of the emergency broadcast system.) $(bold,negative It is only a test!)</message>
    <message>$(bold,italic This is a test of the) $(RED emergency) $(bold,italic broadcast system.)</message>
    <message>$(blinking,negative,YELLOW!  HELP! ) I've fallen, and can't get up!</message>
```

Nesting is not supported, so the second example is slightly more verbose than it could be.
